!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ThetaHlsJsFragmentLoader=t():e.ThetaHlsJsFragmentLoader=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(o){if(r[o])return r[o].exports;var n=r[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,o){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),u=function e(t,r,o){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,o)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(o)},l=r(2),s=function(e){return e&&e.__esModule?e:{default:e}}(l),f=function(e){function t(){return o(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),i(t,[{key:"rangeCheck",value:function(e){var t=this;$.ajax({type:"head",async:!0,url:e.url,crossdomain:!0,beforeSend:function(){s.default.log("Sending HEAD request to url "+e.url),t.segmentEtag=null,t.contentLength=null}}).done(function(e,r,o){t.contentLength=o.getResponseHeader("Content-Length"),t.segmentEtag=o.getResponseHeader("etag"),s.default.log("HEAD request successful, etag="+t.segmentEtag)})}},{key:"integrityCheck",value:function(e){if(s.default.log("integrityCheck etag="+this.segmentEtag),this.segmentEtag){var t=md5(e),r='"'===this.segmentEtag[0]?this.segmentEtag.substring(1,this.segmentEtag.length-1):this.segmentEtag;return s.default.log("verifying md5 checksum of the segment md5sum="+t),t===r}return!0}},{key:"load",value:function(e,t,r){var o=this;if(s.default.info("URL "+e.url),this.thetaCtx.cache.has(e.url))s.default.info("load from cache - ",e.url),this.loadFromCache(e,t,r);else if(null===this.thetaCtx.p2p.id)s.default.info("not connected to peerjs, load from CDN..."),this.loadFromCDN(e,t,r);else if(this.thetaCtx.p2p.useCDN)s.default.info("configuration has useCDN enabled, load from CDN..."),this.loadFromCDN(e,t,r);else{var n=this.thetaCtx.p2p,a=this.thetaCtx.playerStats;if(0===Object.keys(n.peers).length){s.default.info("no peer yet for "+n.id+", load from CDN");Math.floor(Date.now());this.loadFromCDN(e,t,r)}else{var i=Math.floor(Date.now()),u=this.thetaCtx.p2p.probeTimeout;Math.floor(4*Math.random());n.probeFromPeerWithTimeout(e.url,u,1,0).then(function(u){s.default.info("probeFromPeerWithTimeout",u);var l=Math.floor(Date.now());s.default.info("probeFromPeerWithTimeout - fragment "+e.url+" found from peer "+u.peerid);var f=u.peerid;a.processFragmentReq(f,"probe_req_overview_replied"),a.processProbeReq(f,l-i),n.loadFromSpecificPeerWithTimeout(e.url,f).then(function(i){"kOK"===i.result?o.loadFromPeer(e,i,f,a,l,n,r):(s.default.warn("remote peer "+f+" reject getFragment req, try CDN"),a.processFragmentReq(f,"fragment_req_rejected"),o.loadFromCDN(e,t,r))}).catch(function(n){s.default.warn("loadFromSpecificPeer gets timeout, "+e.url+" try CDN  - "+f),s.default.error("error message -",n.message),a.processFragmentReq(f,"fragment_req_timeout"),o.loadFromCDN(e,t,r)})}).catch(function(n){s.default.warn("probeFromPeerWithTimeout ends, "+u+" timeout"),o.thetaCtx.playerStats.processFragmentReq(null,"probe_req_overview_timeout"),o.loadFromCDN(e,t,r)})}}}},{key:"loadFromCache",value:function(e,t,r){s.default.info("Serving from cache: ",e.origin_url);var o=this.thetaCtx.cache,n={data:o.get(e.origin_url)[0].data.slice(0),url:e.origin_url},a=o.get(e.origin_url)[1];r.onSuccess(n,a,e)}},{key:"loadFromPeer",value:function(e,t,r,o,n,a,i){s.default.info("fragment "+t.url+" received from peer "+r);var u={url:t.url,data:t.data},l={size:t.data.byteLength},f=Math.floor(Date.now()),c=null;if(s.default.info("getFragment from peer, takes "+(f-n)+" ms"),!this.integrityCheck(u.data.slice(0)))return void s.default.error("segment integrity check (from peer) fails, skip loading");t.invoice&&(c=t.invoice.address),this.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:u.data.byteLength},peer:{id:r,address:c}}),this.thetaCtx.cache.set(e.url,[{data:t.data.slice(0),url:t.url},l,e]),o.processFragment(e.url,"fromPeer",t.data.byteLength,f-n),o.processFragmentReq(r,"fragment_req_replied");var d=a.peers[r];try{t.invoice?(s.default.debug("Sending payment to "+t.invoice.address),a.sendPayment(t.invoice,d)):s.default.debug("No invoice is included in peer response. Skipping payment.")}catch(e){s.default.error("Error sending payment: ",e)}i.onSuccess(u,l,e)}},{key:"loadFromCDN",value:function(e,r,o){var n=this;s.default.info("ThetaHlsJsFragmentLoader: loadFromCDN");var a=(this.thetaCtx,this.thetaCtx.cache),i=o.onSuccess,l=Math.floor(Date.now()),f=this.thetaCtx.playerStats;o.onSuccess=function(e,t,r){var o=Math.floor(Date.now()),u=o-l;if(s.default.info("getFragment from CDN, "+e.data.byteLength+" bytes takes "+u+" ms"),f.processFragment(r.url,"fromCDN",e.data.byteLength,o-l),!n.integrityCheck(e.data.slice(0)))return void s.default.error("segment integrity check (from CDN) fails, skip loading");a.set(r.url,[{data:e.data.slice(0),url:e.url},t,r]),n.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.CDN,stats:{size:e.data.byteLength},peer:null}),i(e,t,r)},u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"load",this).call(this,e,r,o)}}],[{key:"setDebug",value:function(e){s.default.setLoggingEnabled(e)}}]),t}(Hls.DefaultConfig.loader);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),a=!1,i=function(){function e(){o(this,e)}return n(e,null,[{key:"isLoggingEnabled",value:function(){return a}},{key:"setLoggingEnabled",value:function(e){a=e}},{key:"maybeLog",value:function(e){if(this.isLoggingEnabled()){for(var t,r=arguments.length,o=Array(r>1?r-1:0),n=1;n<r;n++)o[n-1]=arguments[n];(t=console).log.apply(t,["[THETA]["+e+"]"].concat(o))}}},{key:"log",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["log"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["warn"].concat(t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["debug"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["error"].concat(t))}}]),e}();t.default=i,e.exports=t.default}])});