!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ThetaHlsJsFragmentLoader=t():e.ThetaHlsJsFragmentLoader=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in o)return o.value;var i=o.get;if(void 0!==i)return i.call(n)},u=r(2),s=function(e){return e&&e.__esModule?e:{default:e}}(u),f=function(e){function t(){return n(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),i(t,[{key:"rangeCheck",value:function(e){var t=this;$.ajax({type:"head",async:!0,url:e.url,crossdomain:!0,beforeSend:function(){s.default.log("Sending HEAD request to url "+e.url),t.segmentEtag=null,t.contentLength=null}}).done(function(e,r,n){t.contentLength=n.getResponseHeader("Content-Length"),t.segmentEtag=n.getResponseHeader("etag"),s.default.log("HEAD request successful, etag="+t.segmentEtag)})}},{key:"integrityCheck",value:function(e){if(s.default.log("integrityCheck etag="+this.segmentEtag),this.segmentEtag){var t=md5(e),r='"'===this.segmentEtag[0]?this.segmentEtag.substring(1,this.segmentEtag.length-1):this.segmentEtag;return s.default.log("verifying md5 checksum of the segment md5sum="+t),t===r}return!0}},{key:"load",value:function(e,t,r){var n=this;if(s.default.info("URL "+e.url),this.thetaCtx.cache.has(e.url))s.default.info("load from cache - ",e.url),this.loadFromCache(e,t,r);else if(null===this.thetaCtx.p2p.id)s.default.info("not connected to peerjs, load from CDN..."),this.loadFromCDN(e,t,r);else if(this.thetaCtx.p2p.useCDN)s.default.info("configuration has useCDN enabled, load from CDN..."),this.loadFromCDN(e,t,r);else{var o=this.thetaCtx.p2p,a=this.thetaCtx.playerStats;if(0===Object.keys(o.peers).length){s.default.info("no peer yet for "+o.id+", load from CDN");Math.floor(Date.now());this.loadFromCDN(e,t,r)}else{var i=Math.floor(Date.now()),l=this.thetaCtx.p2p.probeTimeout,u=Math.floor(9*Math.random())-4;o.probeFromPeerWithTimeout(e.url,l,1,u).then(function(l){var u=Math.floor(Date.now());s.default.info("probeFromPeerWithTimeout - fragment "+e.url+" found from peer "+l.peerid);var f=l.peerid;a.processFragmentReq(f,"probe_req_overview_replied"),a.processProbeReq(f,u-i),o.loadFromSpecificPeerWithTimeout(e.url,f).then(function(i){"kOK"===i.result?n.loadFromPeer(e,i,f,a,u,o,r):(s.default.warn("remote peer "+f+" reject getFragment req, try CDN"),a.processFragmentReq(f,"fragment_req_rejected"),n.loadFromCDN(e,t,r))}).catch(function(o){s.default.warn("loadFromSpecificPeer gets timeout, "+e.url+" try CDN  - "+f),s.default.error("error message -",o.message),a.processFragmentReq(f,"fragment_req_timeout"),n.loadFromCDN(e,t,r)})}).catch(function(o){s.default.warn("probeFromPeerWithTimeout ends, "+l+" timeout"),n.thetaCtx.playerStats.processFragmentReq(null,"probe_req_overview_timeout"),n.loadFromCDN(e,t,r)})}}}},{key:"loadFromCache",value:function(e,t,r){s.default.info("Serving from cache: ",e.origin_url);var n=this.thetaCtx.cache,o=n.get(e.origin_url),a=null,i=null;null!==o&&void 0!==o&&(a=o[0].data.slice(0),i=o[1]);var l={data:a,url:e.origin_url};r.onSuccess(l,i,e)}},{key:"loadFromPeer",value:function(e,t,r,n,o,a,i){s.default.info("fragment "+t.url+" received from peer "+r);var l={url:t.url,data:t.data},u={size:t.data.byteLength,loaded:t.data.byteLength,trequest:performance.now()},f=Math.floor(Date.now()),c=null;if(s.default.info("getFragment from peer, takes "+(f-o)+" ms"),!this.integrityCheck(l.data.slice(0)))return void s.default.error("segment integrity check (from peer) fails, skip loading");t.invoice&&(c=t.invoice.address),this.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:l.data.byteLength},peer:{id:r,address:c}}),this.thetaCtx.cache.set(e.url,[{data:t.data.slice(0),url:t.url},u,e]),n.processFragment(e.url,"fromPeer",t.data.byteLength,f-o),n.processFragmentReq(r,"fragment_req_replied");var d=a.peers[r];try{t.invoice?(s.default.debug("Sending payment to "+t.invoice.address),a.sendPayment(t.invoice,d)):s.default.debug("No invoice is included in peer response. Skipping payment.")}catch(e){s.default.error("Error sending payment: ",e)}i.onSuccess(l,u,e)}},{key:"loadFromCDN",value:function(e,r,n){var o=this;s.default.info("ThetaHlsJsFragmentLoader: loadFromCDN");var a=(this.thetaCtx,this.thetaCtx.cache),i=n.onSuccess,u=Math.floor(Date.now()),f=this.thetaCtx.playerStats;n.onSuccess=function(e,t,r){var n=Math.floor(Date.now()),l=n-u;if(s.default.info("getFragment from CDN, "+e.data.byteLength+" bytes takes "+l+" ms"),f.processFragment(r.url,"fromCDN",e.data.byteLength,n-u),!o.integrityCheck(e.data.slice(0)))return void s.default.error("segment integrity check (from CDN) fails, skip loading");a.set(r.url,[{data:e.data.slice(0),url:e.url},t,r]),o.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.CDN,stats:{size:e.data.byteLength},peer:null}),i(e,t,r)},l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"load",this).call(this,e,r,n)}}],[{key:"setDebug",value:function(e){s.default.setLoggingEnabled(e)}}]),t}(Hls.DefaultConfig.loader);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=!1,i=function(){function e(){n(this,e)}return o(e,null,[{key:"isLoggingEnabled",value:function(){return a}},{key:"setLoggingEnabled",value:function(e){a=e}},{key:"maybeLog",value:function(e){if(this.isLoggingEnabled()){for(var t,r=arguments.length,n=Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];(t=console).log.apply(t,["[THETA]["+e+"]"].concat(n))}}},{key:"log",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["log"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["warn"].concat(t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["debug"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["error"].concat(t))}}]),e}();t.default=i,e.exports=t.default}])});