!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ThetaHlsJsFragmentLoader=t():e.ThetaHlsJsFragmentLoader=t()}("undefined"!=typeof self?self:this,function(){return function(r){var n={};function o(e){if(n[e])return n[e].exports;var t=n[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}return o.m=r,o.c=n,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,o=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),a=r(2),c=(n=a)&&n.__esModule?n:{default:n};var i=function(e){function n(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(n,Hls.DefaultConfig.loader),o(n,[{key:"rangeCheck",value:function(e){var n=this;$.ajax({type:"head",async:!0,url:e.url,crossdomain:!0,beforeSend:function(){c.default.log("Sending HEAD request to url "+e.url),n.segmentEtag=null,n.contentLength=null}}).done(function(e,t,r){n.contentLength=r.getResponseHeader("Content-Length"),n.segmentEtag=r.getResponseHeader("etag"),c.default.log("HEAD request successful, etag="+n.segmentEtag)})}},{key:"integrityCheck",value:function(e){if(c.default.log("integrityCheck etag="+this.segmentEtag),this.segmentEtag){var t=md5(e),r='"'===this.segmentEtag[0]?this.segmentEtag.substring(1,this.segmentEtag.length-1):this.segmentEtag;return c.default.log("verifying md5 checksum of the segment md5sum="+t),t===r}return!0}},{key:"load",value:function(n,o,a){var i=this;if(c.default.info("URL "+n.url),this.thetaCtx.cache.has(n.url))c.default.info("load from cache - ",n.url),this.loadFromCache(n,o,a);else if(null===this.thetaCtx.p2p.id)c.default.info("not connected to peerjs, load from CDN..."),this.thetaCtx.p2p.firstPeerReq&&(this.thetaCtx.changePeerStatInterval(),this.thetaCtx.changePeerReqInterval(),this.thetaCtx.p2p.firstPeerReq=!1),this.loadFromCDN(n,o,a);else if(this.thetaCtx.useCDN)c.default.info("configuration has useCDN enabled, load from CDN..."),this.loadFromCDN(n,o,a);else{var l=this.thetaCtx.p2p,s=this.thetaCtx.playerStats;if(0===Object.keys(l.peers).length){c.default.info("no peer yet for "+l.id+", load from CDN");Math.floor(Date.now());this.loadFromCDN(n,o,a)}else{var u=Math.floor(Date.now()),t=this.thetaCtx.p2p.probeTimeout;l.probeFromPeerWithTimeout(n.url,t).then(function(e){var t=Math.floor(Date.now());c.default.info("probeFromPeerWithTimeout - fragment "+n.url+" found from peer "+e.peerid);var r=e.peerid;s.processFragmentReq(r,"probe_req_replied"),s.processProbeReq(r,t-u),l.loadFromSpecificPeerWithTimeout(n.url,r).then(function(e){"kOK"===e.result?i.loadFromPeer(n,e,r,s,t,l,a):(c.default.warn('remote peer "%s" reject getFragment req, try CDN',r),s.processFragmentReq(r,"fragment_req_rejected"),i.loadFromCDN(n,o,a))}).catch(function(e){c.default.warn('loadFromSpecificPeer gets timeout, "%s" try CDN  - "%s"',n.url,r),c.default.error("error message -",e.message),s.processFragmentReq(r,"fragment_req_timeout"),i.loadFromCDN(n,o,a)})}).catch(function(e){c.default.warn('probeFromPeerWithTimeout, "%s ms" timeout',t),i.thetaCtx.playerStats.processFragmentReq(null,"probe_req_timeout"),i.loadFromCDN(n,o,a)})}}}},{key:"loadFromCache",value:function(e,t,r){c.default.info("Serving from cache: ",e.origin_url);var n=this.thetaCtx.cache,o={data:n.get(e.origin_url)[0].data.slice(0),url:e.origin_url},a=n.get(e.origin_url)[1];r.onSuccess(o,a,e)}},{key:"loadFromPeer",value:function(e,t,r,n,o,a,i){c.default.info('fragment "%s" received from peer "%s"',t.url,r);var l={url:t.url,data:t.data},s={size:t.data.byteLength},u=Math.floor(Date.now());if(c.default.info('getFragment from peer, takes "%s" ms',u-o),this.integrityCheck(l.data.slice(0))){this.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:l.data.byteLength}}),this.thetaCtx.cache.set(e.url,[{data:t.data.slice(0),url:t.url},s,e]),n.processFragment(e.url,"fromPeer",t.data.byteLength,u-o),n.processFragmentReq(r,"fragment_req_replied");var f=a.peers[r];try{t.invoice?(c.default.debug("Sending payment to "+t.invoice.address),a.sendPayment(t.invoice,f)):c.default.debug("No invoice is included in peer response. Skipping payment.")}catch(e){c.default.error("Error sending payment: ",e)}i.onSuccess(l,s,e)}else c.default.error("segment integrity check (from peer) fails, skip loading")}},{key:"loadFromCDN",value:function(e,t,r){var o=this;c.default.info("ThetaHlsJsFragmentLoader: loadFromCDN");this.thetaCtx;var a=this.thetaCtx.cache,i=r.onSuccess,l=Math.floor(Date.now()),s=this.thetaCtx.playerStats;r.onSuccess=function(e,t,r){var n=Math.floor(Date.now());c.default.info('getFragment from CDN, "%s" bytes takes "%s" ms',e.data.byteLength,n-l),s.processFragment(r.url,"fromCDN",e.data.byteLength,n-l),o.integrityCheck(e.data.slice(0))?(a.set(r.url,[{data:e.data.slice(0),url:e.url},t,r]),o.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.CDN,stats:{size:e.data.byteLength}}),i(e,t,r)):c.default.error("segment integrity check (from CDN) fails, skip loading")},function e(t,r,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,r);if(void 0===o){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in o)return o.value;var i=o.get;return void 0!==i?i.call(n):void 0}(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"load",this).call(this,e,t,r)}}]),n}();t.default=i,e.exports=t.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}();var o=!0,a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"isLoggingEnabled",value:function(){return o}},{key:"setLoggingEnabled",value:function(e){o=e}},{key:"maybeLog",value:function(e){if(this.isLoggingEnabled()){for(var t,r=arguments.length,n=Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];(t=console).log.apply(t,["[THETA]["+e+"]"].concat(n))}}},{key:"log",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["log"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["warn"].concat(t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["debug"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["error"].concat(t))}}]),e}();t.default=a,e.exports=t.default}])});