!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ThetaHlsJsFragmentLoader=t():e.ThetaHlsJsFragmentLoader=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";function n(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(a,o){try{var u=t[a](o),i=u.value}catch(e){return void r(e)}if(!u.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});e(i)}return n("next")})}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=function e(t,r,n){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,r);if(void 0===a){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in a)return a.value;var u=a.get;if(void 0!==u)return u.call(n)},l=r(2),c=function(e){return e&&e.__esModule?e:{default:e}}(l),f=function(e){function t(){return a(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return u(t,e),i(t,[{key:"rangeCheck",value:function(e){var t=this;$.ajax({type:"head",async:!0,url:e.url,crossdomain:!0,beforeSend:function(){c.default.log("Sending HEAD request to url "+e.url),t.segmentEtag=null,t.contentLength=null}}).done(function(e,r,n){t.contentLength=n.getResponseHeader("Content-Length"),t.segmentEtag=n.getResponseHeader("etag"),c.default.log("HEAD request successful, etag="+t.segmentEtag)})}},{key:"integrityCheck",value:function(e){if(c.default.log("integrityCheck etag="+this.segmentEtag),this.segmentEtag){var t=md5(e),r='"'===this.segmentEtag[0]?this.segmentEtag.substring(1,this.segmentEtag.length-1):this.segmentEtag;return c.default.log("verifying md5 checksum of the segment md5sum="+t),t===r}return!0}},{key:"load",value:function(e,t,r){var a=this,o=this;$.ajax({type:"head",async:!0,url:e.url,crossdomain:!0,beforeSend:function(){c.default.log("Sending head request to url "+e.url)}}).done(function(){var u=n(regeneratorRuntime.mark(function n(u,i,s){var l,f,g,d,h,p;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:l=parseInt(s.getResponseHeader("Content-Length")),f=a.thetaCtx.p2p.rangeNumber,g=f||4,d=new Array(g),h=o._getSequence(g),c.default.info("sequence: ",h),e.maxNum=g,e.sequence=h,c.default.log("HEAD request successful, contentLength="+l),e.contentLength=l,p=Math.round(l/e.maxNum),e.rangeLength=p,e.crtNum=0,e.rangeNum=e.sequence[e.crtNum],e.rangeStart=e.rangeNum*e.rangeLength,e.rangeEnd=e.rangeNum===e.maxNum-1?e.contentLength:e.rangeLength*(e.rangeNum+1),o.loadSlice(e,t,r,d);case 17:case"end":return n.stop()}},n,a)}));return function(e,t,r){return u.apply(this,arguments)}}())}},{key:"loadSlice",value:function(e,t,r,n){var a=this;if(c.default.info("URL "+e.url+" Range number "+e.rangeNum),this.thetaCtx.cache.has(e.url))c.default.info("load from cache - ",e.url),this.loadFromCache(e,t,r);else if(null===this.thetaCtx.p2p.id)c.default.info("not connected to peerjs, load from CDN..."),this.loadFromCDN(e,t,r,n);else if(this.thetaCtx.p2p.useCDN)c.default.info("configuration has useCDN enabled, load from CDN..."),this.loadFromCDN(e,t,r,n);else{var o=this.thetaCtx.p2p,u=this.thetaCtx.playerStats;if(0===Object.keys(o.peers).length){c.default.info("no peer yet for "+o.id+", load from CDN");Math.floor(Date.now());this.loadFromCDN(e,t,r,n)}else{var i=Math.floor(Date.now()),s=this.thetaCtx.p2p.probeTimeout;o.probeFromPeerWithTimeout(e.url+e.rangeNum,s,1,0).then(function(s){var l=Math.floor(Date.now());c.default.info("probeFromPeerWithTimeout - fragment "+(e.url+e.rangeNum)+" found from peer "+s.peerid);var f=s.peerid;u.processFragmentReq(f,"probe_req_overview_replied"),u.processProbeReq(f,l-i),o.loadFromSpecificPeerWithTimeout(e.url+e.rangeNum,f).then(function(i){"kOK"===i.result?a.loadFromPeer(e,i,f,u,l,o,r,n,t):(c.default.warn("remote peer "+f+" reject getFragment req, try CDN"),u.processFragmentReq(f,"fragment_req_rejected"),a.loadFromCDN(e,t,r,n))}).catch(function(o){c.default.warn("loadFromSpecificPeer gets timeout, "+e.url+" try CDN  - "+f),o.message?c.default.error("error message -",o.message):c.default.error("error without msg -",o),u.processFragmentReq(f,"fragment_req_timeout"),a.loadFromCDN(e,t,r,n)})}).catch(function(o){c.default.warn("probeFromPeerWithTimeout ends, "+s+" timeout"),c.default.warn("probeFromPeerWithTimeout ends with err: ",o);var u=a.thetaCtx.playerStats;"timeout"===o.type?u.processFragmentReq(null,"probe_req_overview_timeout"):u.processFragmentReq(null,"probe_req_overview_notCached"),a.loadFromCDN(e,t,r,n)})}}}},{key:"loadFromCache",value:function(e,t,r){c.default.info("Serving from cache: ",e.origin_url);var n=this.thetaCtx.cache,a=n.get(e.origin_url),o=null,u=null;null!==a&&void 0!==a&&(o=a[0].data.slice(0),u=a[1]);var i={data:o,url:e.origin_url};r.onSuccess(i,u,e)}},{key:"loadFromPeer",value:function(e,t,r,n,a,o,u,i,s){var l=this;c.default.info("fragment "+t.url+" received from peer "+r);var f={url:t.url,data:t.data},g={size:t.data.byteLength,loaded:t.data.byteLength,trequest:performance.now()},d=Math.floor(Date.now()),h=null;if(c.default.info("getFragment from peer, takes "+(d-a)+" ms"),!this.integrityCheck(f.data.slice(0)))return void c.default.error("segment integrity check (from peer) fails, skip loading");t.invoice&&(h=t.invoice.address),this.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:f.data.byteLength},peer:{id:r,address:h}}),this.thetaCtx.cache.set(e.url+e.rangeNum,[{data:t.data.slice(0),url:t.url},g,e]),n.processFragment(e.url+e.rangeNum,"fromPeer",t.data.byteLength,d-a),n.processFragmentReq(r,"fragment_req_replied");var p=o.peers[r];try{t.invoice?(c.default.debug("Sending payment to "+t.invoice.address),o.sendPayment(t.invoice,p)):c.default.debug("No invoice is included in peer response. Skipping payment.")}catch(e){c.default.error("Error sending payment: ",e)}if(i[e.rangeNum]=f.data,this._checkData(i)&&e.crtNum===e.maxNum-1){var m={url:f.url,data:i.reduce(function(e,t){return l._appendBuffer(e,t)},new ArrayBuffer)};i=new Array(3),u.onSuccess(m,g,e)}else{var y=Object.assign({},u),v=Object.assign({},e);v.crtNum++,v.rangeNum=v.sequence[v.crtNum],v.rangeStart=v.rangeNum*v.rangeLength,v.rangeEnd=v.rangeNum===v.maxNum-1?v.contentLength:v.rangeLength*(v.rangeNum+1),this.loadSlice(v,s,y,i)}}},{key:"loadFromCDN",value:function(e,t,r,n){var a=Math.floor(Date.now()),o=this,u=new XMLHttpRequest;try{u.open("GET",e.url,!0)}catch(t){return void r.onError({code:u.status,text:t.message},e,u)}e.rangeEnd&&u.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),u.responseType=e.responseType,u.callbacks=r;var i=this.thetaCtx.playerStats;u.onload=function(s){c.default.info(u.response);var l=u.response;if(l){var f=Object.assign({},r),g=f.onSuccess,d=o.thetaCtx.cache,h={size:l.byteLength,loaded:l.byteLength,trequest:performance.now()};u.callbacks.onSuccess=function(r,u,s){c.default.info("On Success ctx: ",s.rangeNum,s);var l=Math.floor(Date.now()),h=l-a;if(c.default.info("getFragment from CDN, "+r.data.byteLength+" bytes takes "+h+" ms"),i.processFragment(s.url+s.rangeNum,"fromCDN",r.data.byteLength,l-a),d.set(s.url+s.rangeNum,[{data:r.data.slice(0),url:r.url},u,s]),o.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.CDN,stats:{size:r.data.byteLength},peer:null}),n[e.rangeNum]=r.data,o._checkData(n)&&e.crtNum===e.maxNum-1){var p={url:r.url,data:n.reduce(function(e,t){return o._appendBuffer(e,t)},new ArrayBuffer)};g(p,u,e)}else{var m=Object.assign({},e);m.crtNum++,m.rangeNum=m.sequence[m.crtNum],m.rangeStart=m.rangeNum*m.rangeLength,m.rangeEnd=m.rangeNum===m.maxNum-1?m.contentLength:m.rangeLength*(m.rangeNum+1),o.loadSlice(m,t,f,n)}};var p={url:u.responseURL,data:l};u.onreadystatechange=o.readystatechange.bind(o),u.callbacks.onSuccess(p,h,e)}},u.send()}},{key:"readystatechange",value:function(e){s(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"readystatechange",this).call(this,e)}},{key:"_getSequence",value:function(e){for(var t=[],r=0;r<e;r++)t[r]=r;return t=this._shuffle(t)}},{key:"_shuffle",value:function(e){for(var t=e.length,r=void 0,n=void 0;t>0;)n=Math.floor(Math.random()*t),t--,r=e[t],e[t]=e[n],e[n]=r;return e}},{key:"_appendBuffer",value:function(e,t){var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}},{key:"_checkData",value:function(e){for(var t=0;t<e.length;t++)if(void 0===e[t])return!1;return!0}}],[{key:"setDebug",value:function(e){c.default.setLoggingEnabled(e)}}]),t}(Hls.DefaultConfig.loader);t.default=f,e.exports=t.default},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=!1,u=function(){function e(){n(this,e)}return a(e,null,[{key:"isLoggingEnabled",value:function(){return o}},{key:"setLoggingEnabled",value:function(e){o=e}},{key:"maybeLog",value:function(e){if(this.isLoggingEnabled()){for(var t,r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];(t=console).log.apply(t,["[THETA]["+e+"]"].concat(n))}}},{key:"log",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["log"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["warn"].concat(t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["debug"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["error"].concat(t))}}]),e}();t.default=u,e.exports=t.default}])});